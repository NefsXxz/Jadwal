<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengingat PR - MAN BARITO UTARA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f0f2f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .notification-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        textarea {
            height: 80px;
        }
        
        .task-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .task-info h3 {
            margin-bottom: 5px;
        }
        
        .task-meta {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .status-enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Pengingat PR</h1>
            <p>MAN BARITO UTARA - Kelas X.9 ATAS</p>
            
            <div class="notification-controls">
                <button class="btn btn-primary" onclick="requestNotificationPermission()">
                    üîî Minta Izin Notifikasi
                </button>
                <button class="btn btn-success" onclick="testNotification()">
                    üß™ Tes Notifikasi Sekarang
                </button>
                <div id="notificationStatus" class="status status-disabled">
                    Notifikasi: Belum Diizinkan
                </div>
            </div>
        </header>

        <div class="card">
            <h2>‚ûï Tambah PR Baru</h2>
            <form id="taskForm">
                <div class="form-group">
                    <label for="subject">Mata Pelajaran</label>
                    <input type="text" id="subject" placeholder="Contoh: Matematika" required>
                </div>
                
                <div class="form-group">
                    <label for="taskDescription">Detail Tugas</label>
                    <textarea id="taskDescription" placeholder="Jelaskan tugas yang harus dikerjakan..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="dueDate">Tanggal Pengumpulan</label>
                    <input type="date" id="dueDate" required>
                </div>
                
                <div class="form-group">
                    <label for="dueTime">Waktu Pengumpulan</label>
                    <input type="time" id="dueTime" required>
                </div>
                
                <div class="form-group">
                    <label for="reminderTime">Ingatkan Saya</label>
                    <select id="reminderTime">
                        <option value="1">1 menit (testing)</option>
                        <option value="2">2 menit (testing)</option>
                        <option value="15">15 menit sebelumnya</option>
                        <option value="30">30 menit sebelumnya</option>
                        <option value="60">1 jam sebelumnya</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üíæ Simpan Pengingat
                </button>
            </form>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>üìã Daftar PR Saya</h2>
            <div id="taskList">
                <p style="text-align: center; color: #666; padding: 20px;">
                    Belum ada PR. Tambahkan PR pertama Anda!
                </p>
            </div>
        </div>
    </div>

    <script>
        // Variabel global
        let notificationTimeouts = {};
        
        // Fungsi untuk meminta izin notifikasi
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("Browser ini tidak mendukung notifikasi desktop");
                return;
            }
            
            Notification.requestPermission().then(function(permission) {
                updateNotificationStatus(permission);
                
                if (permission === "granted") {
                    alert("‚úÖ Izin notifikasi diberikan! Sekarang Anda bisa menerima pengingat PR.");
                } else {
                    alert("‚ùå Izin notifikasi ditolak. Anda tidak akan menerima pengingat PR.");
                }
            });
        }
        
        // Fungsi untuk memperbarui status notifikasi
        function updateNotificationStatus(permission) {
            const statusElement = document.getElementById("notificationStatus");
            
            if (permission === "granted") {
                statusElement.textContent = "Notifikasi: Diizinkan ‚úÖ";
                statusElement.className = "status status-enabled";
            } else {
                statusElement.textContent = "Notifikasi: Belum Diizinkan ‚ùå";
                statusElement.className = "status status-disabled";
            }
        }
        
        // Fungsi untuk testing notifikasi
        function testNotification() {
            if (Notification.permission !== "granted") {
                alert("Silakan izinkan notifikasi terlebih dahulu dengan menekan tombol 'Minta Izin Notifikasi'");
                return;
            }
            
            // Buat notifikasi test
            const notification = new Notification("üß™ Test Notifikasi Berhasil!", {
                body: "Notifikasi PR Anda akan muncul seperti ini. Jika tidak muncul, periksa pengaturan browser Anda.",
                icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233498db'%3E%3Cpath d='M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z'/%3E%3C/svg%3E",
                requireInteraction: true
            });
            
            // Tutup notifikasi setelah 5 detik
            setTimeout(() => {
                notification.close();
            }, 5000);
        }
        
        // Fungsi untuk menyimpan PR
        function savePR(event) {
            event.preventDefault();
            
            const subject = document.getElementById("subject").value;
            const description = document.getElementById("taskDescription").value;
            const dueDate = document.getElementById("dueDate").value;
            const dueTime = document.getElementById("dueTime").value;
            const reminderTime = parseInt(document.getElementById("reminderTime").value);
            
            // Validasi
            if (!subject || !description || !dueDate || !dueTime) {
                alert("Harap isi semua field!");
                return;
            }
            
            const dueDateTime = new Date(`${dueDate}T${dueTime}`);
            if (dueDateTime <= new Date()) {
                alert("Waktu pengumpulan harus di masa depan!");
                return;
            }
            
            // Buat objek PR
            const task = {
                id: Date.now(),
                subject,
                description,
                dueDate: dueDateTime.toISOString(),
                reminderTime,
                createdAt: new Date().toISOString()
            };
            
            // Simpan ke localStorage
            saveTaskToStorage(task);
            
            // Jadwalkan notifikasi
            scheduleNotification(task);
            
            // Reset form
            document.getElementById("taskForm").reset();
            
            // Set default waktu untuk next input
            setDefaultDateTime();
            
            // Refresh daftar PR
            loadTasks();
            
            alert("‚úÖ PR berhasil disimpan! Notifikasi akan muncul " + reminderTime + " menit sebelum waktu pengumpulan.");
        }
        
        // Fungsi untuk menyimpan ke localStorage
        function saveTaskToStorage(task) {
            const tasks = getTasksFromStorage();
            tasks.push(task);
            localStorage.setItem("prTasks", JSON.stringify(tasks));
        }
        
        // Fungsi untuk mengambil dari localStorage
        function getTasksFromStorage() {
            return JSON.parse(localStorage.getItem("prTasks")) || [];
        }
        
        // Fungsi untuk menjadwalkan notifikasi
        function scheduleNotification(task) {
            if (Notification.permission !== "granted") {
                console.log("Izin notifikasi belum diberikan");
                return;
            }
            
            const dueDate = new Date(task.dueDate);
            const reminderTime = new Date(dueDate.getTime() - (task.reminderTime * 60 * 1000));
            const now = new Date();
            const timeUntilReminder = reminderTime - now;
            
            console.log("Menjadwalkan notifikasi:", {
                task: task.subject,
                dueDate: dueDate.toLocaleString(),
                reminderTime: reminderTime.toLocaleString(),
                timeUntilReminder: Math.round(timeUntilReminder / 1000) + " detik"
            });
            
            // Jika waktu sudah lewat, skip
            if (timeUntilReminder <= 0) {
                console.log("Waktu notifikasi sudah lewat, tidak menjadwalkan");
                return;
            }
            
            const timeoutId = setTimeout(() => {
                console.log("Menampilkan notifikasi untuk:", task.subject);
                
                const notification = new Notification(`üìö Pengingat PR: ${task.subject}`, {
                    body: `PR "${task.subject}" harus dikumpulkan pada ${dueDate.toLocaleDateString('id-ID')} pukul ${dueDate.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}\n\nDetail: ${task.description}`,
                    icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e74c3c'%3E%3Cpath d='M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z'/%3E%3C/svg%3E",
                    requireInteraction: true,
                    tag: `pr-reminder-${task.id}`
                });
                
                // Tutup notifikasi setelah 10 detik
                setTimeout(() => {
                    notification.close();
                }, 10000);
                
                // Hapus dari timeout tracker
                delete notificationTimeouts[task.id];
                
            }, timeUntilReminder);
            
            // Simpan timeout ID untuk bisa dibatalkan nanti
            notificationTimeouts[task.id] = timeoutId;
        }
        
        // Fungsi untuk memuat daftar PR
        function loadTasks() {
            const tasks = getTasksFromStorage();
            const taskList = document.getElementById("taskList");
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada PR. Tambahkan PR pertama Anda!</p>';
                return;
            }
            
            taskList.innerHTML = "";
            
            tasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                const taskElement = document.createElement("div");
                taskElement.className = "task-item";
                taskElement.innerHTML = `
                    <h3>${task.subject}</h3>
                    <div class="task-meta">
                        <strong>Batas Waktu:</strong> ${dueDate.toLocaleDateString('id-ID')} pukul ${dueDate.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})} |
                        <strong>Pengingat:</strong> ${task.reminderTime} menit sebelumnya
                    </div>
                    <p>${task.description}</p>
                    <button class="btn btn-danger" onclick="deleteTask(${task.id})" style="margin-top: 10px;">
                        üóëÔ∏è Hapus
                    </button>
                `;
                taskList.appendChild(taskElement);
            });
        }
        
        // Fungsi untuk menghapus PR
        function deleteTask(taskId) {
            if (!confirm("Apakah Anda yakin ingin menghapus PR ini?")) {
                return;
            }
            
            // Batalkan notifikasi yang terjadwal
            if (notificationTimeouts[taskId]) {
                clearTimeout(notificationTimeouts[taskId]);
                delete notificationTimeouts[taskId];
            }
            
            // Hapus dari storage
            const tasks = getTasksFromStorage().filter(task => task.id !== taskId);
            localStorage.setItem("prTasks", JSON.stringify(tasks));
            
            // Refresh daftar
            loadTasks();
            
            alert("PR berhasil dihapus!");
        }
        
        // Fungsi untuk set default datetime
        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 2); // Default 2 menit dari sekarang
            
            document.getElementById("dueDate").value = now.toISOString().split("T")[0];
            document.getElementById("dueTime").value = now.toTimeString().substring(0, 5);
        }
        
        // Inisialisasi aplikasi
        function initApp() {
            // Setup form submit
            document.getElementById("taskForm").addEventListener("submit", savePR);
            
            // Set default datetime
            setDefaultDateTime();
            
            // Load existing tasks
            loadTasks();
            
            // Check notification permission status
            if (Notification.permission === "granted") {
                updateNotificationStatus("granted");
            }
            
            console.log("Aplikasi siap! Status notifikasi:", Notification.permission);
        }
        
        // Jalankan ketika halaman dimuat
        document.addEventListener("DOMContentLoaded", initApp);
    </script>
</body>
</html>
